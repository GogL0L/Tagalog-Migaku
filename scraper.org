#+title: Tagalog dictionary scraper
#+description: Scrapes the dictionary "" and saves it to the file dictionary.json and conjugations.json in the migaku format.

* Scraping test
** Header 

#+begin_src fsharp :results output :session
#r "nuget: FSharp.Data, 4.0.1"
#r "nuget: FsVerbalExpressions, 0.6.1"

open FSharp.Data
//open System.Text.RegularExpressions
open FsVerbalExpressions.FsRegEx

//let doc = HtmlDocument.Load("https://google.com")
//printfn "The site: %A" doc
printfn "Hello world with regex (good tho)!"
#+end_src

#+RESULTS:
: /tmp/nuget/22589--e9f65657-4398-4773-9599-433f169cd7cb/Project.fsproj : warning NU1701: Package 'FsVerbalExpressions 0.6.1' was restored using '.NETFramework,Version=v4.6.1, .NETFramework,Version=v4.6.2, .NETFramework,Version=v4.7, .NETFramework,Version=v4.7.1, .NETFramework,Version=v4.7.2, .NETFramework,Version=v4.8' instead of the project target framework 'net5.0'. This package may not be fully compatible with your project.
: /tmp/nuget/22589--e9f65657-4398-4773-9599-433f169cd7cb/Project.fsproj : warning NU1701: Package 'FsVerbalExpressions 0.6.1' was restored using '.NETFramework,Version=v4.6.1, .NETFramework,Version=v4.6.2, .NETFramework,Version=v4.7, .NETFramework,Version=v4.7.1, .NETFramework,Version=v4.7.2, .NETFramework,Version=v4.8' instead of the project target framework 'net5.0'. This package may not be fully compatible with your project.
: [Loading /tmp/nuget/22589--e9f65657-4398-4773-9599-433f169cd7cb/Project.fsproj.fsx]
: namespace FSI_0279.Project
: 
: Hello world with regex (good tho)!
** Helper function

#+begin_src fsharp :results output :session
let firstChildText selector (post : HtmlNode) =
    post.CssSelect(selector).[0].DirectInnerText().Trim()
#+end_src

#+RESULTS:

** Actual testning

*** Konvertera wordgroup html node till relevanta saker
#+begin_src fsharp :results output :session
let doc = HtmlDocument.Load("https://tagalog.pinoydictionary.com/")
#+end_src

#+RESULTS:


#+begin_src fsharp :results output :session
let wordGroupToWord (wordGroup : HtmlNode) : string =
    wordGroup.CssSelect(".word-entry").[0]
    |> firstChildText "a"

let wordGroupToInfo (wordGroup : HtmlNode) : string =
    wordGroup.CssSelect(".definition").[0]
    |> firstChildText "p"


let words = doc.CssSelect(".word-group")

//let example_word = words.[0].CssSelect(".definition").[0]
let example_word_group = words.[6]
//let test = example_word.CssSelect(".word")
let test_word = wordGroupToWord example_word_group
let test_info = wordGroupToInfo example_word_group

let wordToEntry (word: HtmlNode) : Entry = {Word = ""
                                            Definition = ""
                                            Conjugations = []}

printfn "The word: %A. The info: %A." test_word test_info
#+end_src

#+RESULTS:
#+begin_example
The word: "ikawala". The info: "ikawala (ikinawawala, ikinawala, ikawawala) v., inf. lose; cause to lose".
val wordGroupToWord : wordGroup:HtmlNode -> string
val wordGroupToInfo : wordGroup:HtmlNode -> string
val words : HtmlNode list =
  [<div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/akasya/">akasya</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>aksaya adj. wasteful; wasted</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/alagad-ng-batas/">alagad ng batas</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>alagad ng batas n. agent of the law</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/area/">area</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>area n. area</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/baligwasan/">baligwasan</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>baligwasan n. fishing rod</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/dagos/">dagos</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>n. 1. hurried departure in anger, etc.; 2. sound of dragging something hurriedly</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/hilom/">hilom</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>n. closing up of an opening (crevice)</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/ikawala/">ikawala</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>ikawala (ikinawawala, ikinawala, ikawawala) v., inf. lose; cause to lose</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/isali/">isali</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>(isinasali, isinali, isasali) v., inf. include someone as a participant</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/luwal/">luwal</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>luwal n. exterior; outside</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/maitatagubilin/">maitatagubilin</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>maitatagubilin v., adj. advisable; able to be recommended</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/makipaghiwalay/">makipaghiwalay</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>makipaghiwalay (nakikipaghiwalay, nakipaghiwalay, makikipaghiwalay) v., inf. 1. mutually separate; 2. estrange; 3. diverge</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/managi/">managi</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>managi (nananagi, nanagi, mananagi) v., inf. push or elbow oneself through a crowd</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/masalubsob/">masalubsob</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>masalubsob (nasasalubsob, nasalubsob, masasalubsob) v., inf. be pierced or hurt by a splinter</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/pagkokorek/">pagkokorek</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>pagkokorek n. correction; act of correcting</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/panag-ulan/">panag-ulan</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>panag-ulan n., adj. anything pertaining to the rainy season</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/pumukaw/">pumukaw</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>(pumupukaw, pumukaw, pupukaw) v., inf. incite; arouse; excite</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/rabies/">rabies</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>n., med. rabies (disease of a mad dog)</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/tuay/">tuay</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>tuay n. 1. exchange; barter; 2. favour (US: favor) done for favour received</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/tudlain/">tudlain</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>tudlain (tinutudla, tinudla, tutudlain) v., inf. shoot at a target</p>
  </div>
</div>;
   <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/umabala/">umabala</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>(umaabala, umabala, aabala) v., inf. delay; hinder</p>
  </div>
</div>]
val example_word_group : HtmlNode =
  <div class="word-group">
  <div class="word">
    <h2 class="word-entry">
      <a href="https://tagalog.pinoydictionary.com/word/ikawala/">ikawala</a>
    </h2><p class="label label-success language">Tagalog</p>
  </div>
  <div class="definition" data-language="tagalog">
    <p>ikawala (ikinawawala, ikinawala, ikawawala) v., inf. lose; cause to lose</p>
  </div>
</div>
val test_word : string = "ikawala"
val test_info : string =
  "ikawala (ikinawawala, ikinawala, ikawawala) v., inf. lose; cause to lose"
val wordToEntry : word:HtmlNode -> Entry
#+end_example

*** Regex stuff

#+begin_src fsharp :results output :session
let test_string = "stuff (isinasali, isinali, isasali) inff., inf. in. clude someone as a participant"

let test_string2 = "stuutuf inf. this should (should, not) . not be in"
//let result =  Regex.Match (test_string, "(.+?)\." )
//let result_paren = Regex.Match (result, "(.+)")
//printfn "The result is %A" <| result.GetType ()
let infoToConjugations (info:string) : List<string> =
    let prefix = @"(.+?)\."
    let parenthesis = @"\((?<conjugations>.*)\)"
    info
    |> matches prefix
    |> Array.head
    |> sprintf "%A"
    |> capture parenthesis "conjugations"
    |> sprintf "%s"
    |> fun str -> str.Split [|','|]
    |> Seq.map (fun str -> str.Trim ())
    |> Seq.toList
    |> fun lst -> if lst = [""] then [] else lst
    //|> List.map String.Trim


let infoToDefinitions (info:string) : string =
    let suffix = @"\w*\.(.+)"
    info
    |> matches suffix
    |> Array.head
    |> sprintf "%A"


let result = infoToDefinitions test_string

printfn "type of hello: %A" <| result.GetType ()
printfn "the value of result: %A" <| result
#+end_src

#+RESULTS:
: type of hello: System.String
: the value of result: "inff., inf. in. clude someone as a participant"
: val test_string : string =
:   "stuff (isinasali, isinali, isasali) inff., inf. in. clude som"+[21 chars]
: val test_string2 : string =
:   "stuutuf inf. this should (should, not) . not be in"
: val infoToConjugations : info:string -> List<string>
: val infoToDefinitions : info:string -> string
: val result : string = "inff., inf. in. clude someone as a participant"

*** List index

#+begin_src fsharp :results output
printfn "first number %A" <| List.head [1;2;3]
#+end_src

#+RESULTS:
: first number 1

*** Data modelling

#+begin_src fsharp :results output :session
type Entry = {Word: string
              Definition: string
              Conjugations: list<string>}

let word_hello : Entry = {Word= "Hello"
                          Definition= "A common greeting"
                          Conjugations= [ "Hi"; "Yo" ]}

printfn "The word_hello Conjugations: %A" word_hello.Conjugations.[0]
#+end_src

#+RESULTS:
: The word_hello Conjugations: "Hi"
: type Entry =
:   { Word: string
:     Definition: string
:     Conjugations: string list }
: val word_hello : Entry = { Word = "Hello"
:                            Definition = "A common greeting"
:                            Conjugations = ["Hi"; "Yo"] }

* Scraper

** Hemsidan och wordgroups

#+begin_src fsharp :results output :session
let doc = HtmlDocument.Load("https://tagalog.pinoydictionary.com/")
let words = doc.CssSelect(".word-group")
#+end_src

#+RESULTS:
: val doc : HtmlDocument =
:   <!DOCTYPE html>
: <html lang="en">
:   <head>
:     <meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" /><meta name="robots" content="noarchive" /><meta name="googlebot" content="noarchive" /><meta name="google" content="notranslate" /><meta name="generator" content="WordPress 4.9.7" /><title>Tagalog Dictionary</title><meta property="og:image" content="https://www.pinoydictionary.c...


** Data modelling

#+begin_src fsharp :results output :session
type Entry = {Word: string
              Definition: string
              Conjugations: list<string>}
#+end_src

#+RESULTS:


** Konvertera wordgroup html node till relevanta saker

#+begin_src fsharp :results output :session
let wordGroupToWord (wordGroup : HtmlNode) : string =
    wordGroup.CssSelect(".word-entry").[0]
    |> firstChildText "a"

let wordGroupToInfo (wordGroup : HtmlNode) : string =
    wordGroup.CssSelect(".definition").[0]
    |> firstChildText "p"

#+end_src

#+RESULTS:


** Regex stuff

#+begin_src fsharp :results output :session
let infoToConjugations (info:string) : List<string> =
    let prefix = @"(.+?)\."
    let parenthesis = @"\((?<conjugations>.*)\)"
    info
    |> matches prefix
    |> Array.head
    |> sprintf "%A"
    |> capture parenthesis "conjugations"
    |> sprintf "%s"
    |> fun str -> str.Split [|','|]
    |> Seq.map (fun str -> str.Trim ())
    |> Seq.toList
    |> fun lst -> if lst = [""] then [] else lst
    //|> List.map String.Trim


let infoToDefinitions (info:string) : string =
    let suffix = @"\w*\.(.+)"
    info
    |> matches suffix
    |> Array.head
    |> sprintf "%A"

#+end_src

#+RESULTS:



** wordGroupToEntry (samt wordGroupToConj och wordGroupToDef)

#+begin_src fsharp :results output :session
let wordGroupToConj (wordgroup : HtmlNode) : List<string> =
    wordgroup
    |> wordGroupToInfo
    |> infoToConjugations
    

let wordGroupToDef (wordgroup : HtmlNode) : string =
    wordgroup
    |> wordGroupToInfo
    |> infoToDefinitions
    
let wordGroupToEntry (wordgroup : HtmlNode) : Entry =
    {Word = wordGroupToWord wordgroup
     Definition = wordGroupToDef wordgroup
     Conjugations = wordGroupToConj wordgroup}
#+end_src

#+RESULTS:


** Test av wordGroupToEntry

#+begin_src fsharp :results output :session
let result = wordGroupToEntry words.[10]
printfn "The result: %A" result
#+end_src

#+RESULTS:
: The result: { Word = "makipaghiwalay"
:   Definition = "v., inf. 1. mutually separate; 2. estrange; 3. diverge"
:   Conjugations = ["nakikipaghiwalay"; "nakipaghiwalay"; "makikipaghiwalay"] }
: val result : Entry =
:   { Word = "makipaghiwalay"
:     Definition = "v., inf. 1. mutually separate; 2. estrange; 3. diverge"
:     Conjugations = ["nakikipaghiwalay"; "nakipaghiwalay"; "makikipaghiwalay"] }
